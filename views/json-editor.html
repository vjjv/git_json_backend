<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Edit {{FILENAME}}</title>
    <link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.4/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.4/dist/jsoneditor.min.js"></script>
    <style>
      * { box-sizing: border-box; }
      body { 
        font-family: Arial, sans-serif; 
        padding: 10px; 
        background: #f5f5f5; 
        margin: 0;
      }
      .header { 
        margin-bottom: 15px; 
      }
      .back-link { 
        color: #0066cc; 
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 8px;
      }
      .back-link:hover { text-decoration: underline; }
      .file-name { 
        color: #333; 
        margin: 0;
        font-size: 18px;
        word-break: break-all;
      }
      #jsoneditor { 
        width: 100%; 
        height: calc(100vh - 180px);
        min-height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .save-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        margin-right: 8px;
        width: 100%;
        max-width: 200px;
      }
      .save-btn:hover { background: #218838; }
      .save-btn:active { background: #1e7e34; }
      
      .duplicate-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        margin-right: 8px;
        width: 100%;
        max-width: 200px;
      }
      .duplicate-btn:hover { background: #0056b3; }
      .duplicate-btn:active { background: #004085; }
      
      .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        width: 100%;
        max-width: 200px;
      }
      .delete-btn:hover { background: #c82333; }
      .delete-btn:active { background: #bd2130; }
      
      .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .message {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
        font-size: 14px;
      }
      .message.success { background: #d4edda; color: #155724; display: block; }
      .message.error { background: #f8d7da; color: #721c24; display: block; }
      
      /* Hide the "powered by ace" link */
      .jsoneditor-poweredBy { display: none !important; }
      
      @media (max-width: 768px) {
        body { padding: 8px; }
        .file-name { font-size: 16px; }
        .save-btn, .duplicate-btn, .delete-btn { 
          max-width: 100%;
          font-size: 18px;
          padding: 14px;
          margin-right: 0;
        }
        #jsoneditor {
          height: calc(100vh - 160px);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <a href="/" class="back-link">‚Üê Back to files</a>
        <h2 class="file-name">üìù Editing: {{FILENAME}}</h2>
      </div>
    </div>
    <div id="jsoneditor"></div>
    <div class="button-container">
      <button class="save-btn" onclick="saveJson()">üíæ Save Changes</button>
      <button class="duplicate-btn" onclick="duplicateFile()">üìã Duplicate</button>
      <button class="delete-btn" onclick="deleteFile()">üóëÔ∏è Delete</button>
    </div>
    <div id="message" class="message"></div>
    
    <script>
      const container = document.getElementById('jsoneditor');
      const options = {
        mode: 'code',
        modes: ['code', 'tree', 'view'],
        onError: function (err) {
          alert(err.toString());
        }
      };
      const editor = new JSONEditor(container, options);
      editor.set({{JSONDATA}});
      
      async function saveJson() {
        try {
          const json = editor.get();
          const response = await fetch('/save-file', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fileName: '{{FILENAME}}',
              content: json
            })
          });
          
          const result = await response.text();
          const messageEl = document.getElementById('message');
          
          if (response.ok) {
            messageEl.className = 'message success';
            messageEl.textContent = '‚úì ' + result;
          } else {
            messageEl.className = 'message error';
            messageEl.textContent = '‚úó ' + result;
          }
          
          setTimeout(() => {
            messageEl.style.display = 'none';
          }, 3000);
        } catch (error) {
          const messageEl = document.getElementById('message');
          messageEl.className = 'message error';
          messageEl.textContent = '‚úó Error: ' + error.message;
        }
      }
      
      async function duplicateFile() {
        const currentFileName = '{{FILENAME}}';
        const newFileName = prompt('Enter the name for the duplicated file:', currentFileName.replace('.json', '_copy.json'));
        
        if (!newFileName) return;
        
        try {
          const json = editor.get();
          const response = await fetch('/duplicate-file', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fileName: currentFileName,
              newFileName: newFileName,
              content: json
            })
          });
          
          const result = await response.text();
          const messageEl = document.getElementById('message');
          
          if (response.ok) {
            messageEl.className = 'message success';
            messageEl.textContent = '‚úì ' + result;
            setTimeout(() => {
              window.location.href = '/edit-file?file=' + encodeURIComponent(newFileName);
            }, 1500);
          } else {
            messageEl.className = 'message error';
            messageEl.textContent = '‚úó ' + result;
          }
        } catch (error) {
          const messageEl = document.getElementById('message');
          messageEl.className = 'message error';
          messageEl.textContent = '‚úó Error: ' + error.message;
        }
      }
      
      async function deleteFile() {
        const currentFileName = '{{FILENAME}}';
        
        if (!confirm(`Are you sure you want to delete "${currentFileName}"? This action cannot be undone.`)) {
          return;
        }
        
        try {
          const response = await fetch('/delete-file', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fileName: currentFileName
            })
          });
          
          const result = await response.text();
          
          if (response.ok) {
            alert('‚úì File deleted successfully');
            window.location.href = '/';
          } else {
            const messageEl = document.getElementById('message');
            messageEl.className = 'message error';
            messageEl.textContent = '‚úó ' + result;
          }
        } catch (error) {
          const messageEl = document.getElementById('message');
          messageEl.className = 'message error';
          messageEl.textContent = '‚úó Error: ' + error.message;
        }
      }
    </script>
  </body>
</html>
